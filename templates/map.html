{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2 class="border-bottom pb-2">üó∫Ô∏è –¢—É—Ä: ¬´–ü–µ—Ä–º—å –í–µ–ª–∏–∫–∞—è¬ª</h2>
        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <div id="status-bar" class="alert alert-success py-2 d-flex align-items-center shadow-sm">
            <div id="spinner" class="spinner-grow spinner-grow-sm me-2" role="status"></div>
            <span id="status-text" class="fw-bold">–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ-—Ç—É—Ä–∞...</span>
        </div>
        <p class="text-muted small mb-0">
            ‚úã <b>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤:</b> –ö–æ—Å–Ω–∏—Ç–µ—Å—å –∫–∞—Ä—Ç—ã –∏–ª–∏ –ø–æ–∫—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç—É—Ä –Ω–∞ –ø–∞—É–∑—É. 
            –û–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è —Å–∞–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è.
        </p>
    </div>
</div>

<div class="row h-100">
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="col-lg-4 order-lg-2 mb-4">
        <div class="list-group shadow-sm overflow-auto" style="max-height: 600px;">
            <div class="list-group-item list-group-item-action active bg-success border-success">
                –ú–∞—Ä—à—Ä—É—Ç
            </div>
            {% for stop in stops %}
            <a href="/stop/{{ stop.id }}" id="link-{{ loop.index0 }}" class="list-group-item list-group-item-action transition-bg">
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>{{ stop.id }}.</strong> {{ stop.title }}</span>
                    <span class="badge bg-secondary rounded-pill opacity-50" id="badge-{{ loop.index0 }}">Info</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div class="col-lg-8 order-lg-1">
        <!-- –í–∞–∂–Ω–æ: id="map-container" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º—ã—à–∏ -->
        <div id="map-container" style="position: relative;">
            <div id="map" class="shadow-lg border border-3 border-white" style="height: 600px; width: 100%; border-radius: 12px;"></div>
        </div>
    </div>
</div>

<style>
    .transition-bg { transition: all 0.5s ease; }
    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
    .active-item { 
        background-color: #e8f5e9 !important; 
        border-left: 5px solid #2e7d32 !important;
        color: #1b5e20;
    }
</style>

<!-- –°–∫—Ä–∏–ø—Ç –∫–∞—Ä—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. –ù–ê–°–¢–†–û–ô–ö–ò
    var stops = {{ stops | tojson }};
    var isUserInteracting = false;
    var lastInteractionTime = 0;
    var currentStopIndex = 0;
    
    // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
    var map = L.map('map', {
        attributionControl: false,
        zoomControl: false,
        fadeAnimation: true,
        zoomAnimation: true
    });
    
    L.control.zoom({ position: 'topright' }).addTo(map);

    // –õ–µ–≥–∫–∏–µ –∫–∞—Ä—Ç—ã CartoDB (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–µ—Ä—ã—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OSM &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19,
        keepBuffer: 20 // –î–µ—Ä–∂–∏–º –≤ –ø–∞–º—è—Ç–∏ –ø–æ–±–æ–ª—å—à–µ —Ç–∞–π–ª–æ–≤
    }).addTo(map);

    // –ú–∞—Ä–∫–µ—Ä—ã –∏ –ª–∏–Ω–∏—è
    var markersList = []; 
    var markersGroup = L.featureGroup();

    stops.forEach(function(stop) {
        var marker = L.marker(stop.coords);
        var popupContent = `
            <div style="text-align: center;">
                <h6 style="margin: 0; color: #004d40;">${stop.title}</h6>
                <a href="/stop/${stop.id}" class="btn btn-sm btn-success text-white mt-2">–û—Ç–∫—Ä—ã—Ç—å</a>
            </div>
        `;
        marker.bindPopup(popupContent);
        marker.addTo(markersGroup);
        markersList.push(marker);
    });
    markersGroup.addTo(map);

    var routeCoordinates = stops.map(s => s.coords);
    if (routeCoordinates.length > 0) routeCoordinates.push(routeCoordinates[0]);
    L.polyline(routeCoordinates, {
        color: '#d32f2f', weight: 4, opacity: 0.7, dashArray: '10, 10'
    }).addTo(map);

    // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
    var group = new L.featureGroup([markersGroup]);
    map.fitBounds(group.getBounds(), { padding: [50, 50] });

    // =========================================================
    // 3. –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø (DOM EVENTS)
    // =========================================================
    
    // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ù–ê –°–ê–ú–û–ú –ë–õ–û–ö–ï DIV, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ Leaflet.
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –ª–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—è —á–µ–ª–æ–≤–µ–∫–∞.
    const mapDiv = document.getElementById('map');
    const userEvents = ['mousedown', 'touchstart', 'wheel', 'keydown'];

    userEvents.forEach(evt => {
        mapDiv.addEventListener(evt, () => {
            // –ß–µ–ª–æ–≤–µ–∫ —Ç—Ä–æ–Ω—É–ª –∫–∞—Ä—Ç—É!
            isUserInteracting = true;
            lastInteractionTime = Date.now();
            updateStatus(false);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ–ª–µ—Ç –∫–∞—Ä—Ç—ã
            map.stop(); 
        }, { passive: true }); // passive –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∫—Ä–æ–ª–ª–∞
    });

    function updateStatus(active) {
        const text = document.getElementById('status-text');
        const box = document.getElementById('status-bar');
        const spinner = document.getElementById('spinner');
        
        if (active) {
            text.innerText = "–ê–≤—Ç–æ-—Ç—É—Ä –∞–∫—Ç–∏–≤–µ–Ω. –õ–µ—Ç–∏–º –∫ —Ç–æ—á–∫–µ...";
            box.classList.remove('alert-warning');
            box.classList.add('alert-success');
            spinner.style.display = 'inline-block';
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
            text.innerText = "–ü–∞—É–∑–∞. –í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∫–∞—Ä—Ç–æ–π. (–ñ–¥–µ–º 5 —Å–µ–∫)";
            box.classList.remove('alert-success');
            box.classList.add('alert-warning');
            spinner.style.display = 'none';
        }
    }

    // =========================================================
    // 4. –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –¢–£–†–ê
    // =========================================================
    
    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function runTour() {
        // –î–∞–µ–º –∫–∞—Ä—Ç–µ –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
        await wait(2000);

        while (true) {
            // --- –ë–õ–û–ö 1: –ü–†–û–í–ï–†–ö–ê –ü–ê–£–ó–´ ---
            // –ï—Å–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–∞—Å–∞–Ω–∏—è –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 5000 –º—Å
            if (Date.now() - lastInteractionTime < 5000) {
                if (!isUserInteracting) {
                    isUserInteracting = true; // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø–∞—É–∑—ã
                    updateStatus(false);
                }
                await wait(500); // –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
                continue; // –ù–∞—á–∏–Ω–∞–µ–º —Ü–∏–∫–ª –∑–∞–Ω–æ–≤–æ, –Ω–µ –ª–µ—Ç–∏–º –Ω–∏–∫—É–¥–∞
            }
            
            // –ï—Å–ª–∏ –ø–∞—É–∑–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
            if (isUserInteracting) {
                isUserInteracting = false;
                updateStatus(true);
            }

            // --- –ë–õ–û–ö 2: –ü–û–õ–ï–¢ ---
            let currentStop = stops[currentStopIndex];
            let marker = markersList[currentStopIndex];
            let targetZoom = currentStop.zoom || 12;

            // –ö—Ä–∞—Å–∏–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ –º–µ–Ω—é
            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active-item'));
            let activeLink = document.getElementById('link-' + currentStopIndex);
            if (activeLink) {
                activeLink.classList.add('active-item');
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –º–µ–Ω—é –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                activeLink.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // –õ–µ—Ç–∏–º!
            // duration: 4 —Å–µ–∫—É–Ω–¥—ã (–±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≥—Ä—É–∑–∫–∏)
            map.flyTo(currentStop.coords, targetZoom, { duration: 4, easeLinearity: 0.2 });

            // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–ª–µ—Ç–∞ (4 —Å–µ–∫), –Ω–æ –∫–∞–∂–¥—É—é 0.1 —Å–µ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ—Ä–≤–∞–ª –ª–∏ –Ω–∞—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            let flightInterrupted = false;
            for (let t = 0; t < 4200; t += 100) {
                if (Date.now() - lastInteractionTime < 5000) { flightInterrupted = true; break; }
                await wait(100);
            }
            if (flightInterrupted) continue; // –ï—Å–ª–∏ –ø—Ä–µ—Ä–≤–∞–ª–∏ - —É—Ö–æ–¥–∏–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞—É–∑—ã

            // --- –ë–õ–û–ö 3: –°–¢–û–Ø–ù–ö–ê –ù–ê –¢–û–ß–ö–ï ---
            marker.openPopup();
            
            // –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ (–∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏)
            let pauseInterrupted = false;
            for (let t = 0; t < 5000; t += 100) {
                if (Date.now() - lastInteractionTime < 5000) { pauseInterrupted = true; break; }
                await wait(100);
            }
            
            if (!pauseInterrupted) {
                marker.closePopup();
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –º–µ—à–∞–ª
                currentStopIndex++;
                if (currentStopIndex >= stops.length) currentStopIndex = 0;
            }
        }
    }

    // –ó–∞–ø—É—Å–∫
    runTour();

</script>
{% endblock %}
