{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2 class="border-bottom pb-2">üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç: ¬´–ü–µ—Ä–º—å –í–µ–ª–∏–∫–∞—è¬ª</h2>
        <p class="text-muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.</p>
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç—É—Ä–∞ -->
        <button onclick="startTour()" class="btn btn-primary shadow-sm mb-3">
            ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä
        </button>
    </div>
</div>

<div class="row h-100">
    <!-- –ë–ª–æ–∫ —Å–æ —Å–ø–∏—Å–∫–æ–º –º–µ—Å—Ç (–°–∞–π–¥–±–∞—Ä) -->
    <div class="col-lg-4 order-lg-2 mb-4">
        <div class="list-group shadow-sm overflow-auto" style="max-height: 600px;">
            <div class="list-group-item list-group-item-action active bg-success border-success">
                –°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ (10)
            </div>
            {% for stop in stops %}
            <a href="/stop/{{ stop.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ stop.id }}. {{ stop.title }}</strong>
                    <br>
                    <small class="text-muted">{{ stop.short_desc }}</small>
                </div>
                <span class="badge bg-secondary rounded-pill">Info</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- –ë–ª–æ–∫ —Å —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ–π -->
    <div class="col-lg-8 order-lg-1">
        <div id="map" class="shadow-lg border border-3 border-white"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    var map = L.map('map', {
        attributionControl: false
    });
    L.control.attribution({ prefix: false }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" style="color: #666; text-decoration: none;">OpenStreetMap</a>'
    }).addTo(map);

    var stops = {{ stops | tojson }};
    
    // === –í–ê–ñ–ù–û: –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫, –∫—É–¥–∞ –±—É–¥–µ–º —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã ===
    var markersList = []; 
    var markersGroup = L.featureGroup();

    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
    stops.forEach(function(stop) {
        var marker = L.marker(stop.coords);
        
        var popupContent = `
            <div style="text-align: center; min-width: 200px;">
                <h6 style="margin: 0; color: #004d40;">${stop.title}</h6>
                <hr style="margin: 5px 0;">
                <p style="font-size: 12px; margin-bottom: 10px;">${stop.short_desc}</p>
                <a href="/stop/${stop.id}" class="btn btn-sm btn-success text-white">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.addTo(markersGroup);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ –Ω–∞—à —Å–ø–∏—Å–æ–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–æ–º
        markersList.push(marker);
    });

    markersGroup.addTo(map);

    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞ (–∑–∞–º–∫–Ω—É—Ç—É—é)
    var routeCoordinates = stops.map(s => s.coords);
    if (routeCoordinates.length > 0) routeCoordinates.push(routeCoordinates[0]);

    var routeLine = L.polyline(routeCoordinates, {
        color: '#d32f2f', weight: 4, opacity: 0.7, dashArray: '10, 10', lineJoin: 'round'
    }).addTo(map);

    // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
    var group = new L.featureGroup([markersGroup, routeLine]);
    map.fitBounds(group.getBounds(), { padding: [50, 50] });


    // =========================================================
    // –õ–û–ì–ò–ö–ê –í–ò–†–¢–£–ê–õ–¨–ù–û–ì–û –¢–£–†–ê (–ú–∞–≥–∏—è)
    // =========================================================
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–ü–∞—É–∑–∞" (—á—Ç–æ–±—ã –∫–æ–¥ –∂–¥–∞–ª)
    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function startTour() {
        // 1. –°–Ω–∞—á–∞–ª–∞ –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ —Å—Ç–∞—Ä—Ç
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
        await wait(1000); // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º

        // 2. –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –ø–æ –≤—Å–µ–º –º–∞—Ä–∫–µ—Ä–∞–º
        for (let i = 0; i < markersList.length; i++) {
            let marker = markersList[i];
            let coords = stops[i].coords;

            // –ê. –õ–µ—Ç–∏–º –∫ —Ç–æ—á–∫–µ (flyTo –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –ø–ª–∞–≤–Ω–æ)
            // 10 - —ç—Ç–æ —É—Ä–æ–≤–µ–Ω—å –∑—É–º–∞ (–ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è). –ú–æ–∂–µ—Ç–µ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ 12 –∏–ª–∏ 9.
            // duration: 2 - –ø–æ–ª–µ—Ç –¥–ª–∏—Ç—Å—è 2 —Å–µ–∫—É–Ω–¥—ã
            map.flyTo(coords, 10, {
                duration: 2
            });

            // –ë. –ñ–¥–µ–º, –ø–æ–∫–∞ –¥–æ–ª–µ—Ç–∏–º (2 —Å–µ–∫—É–Ω–¥—ã + –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å)
            await wait(2200);

            // –í. –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ (–∫–∞–∫ –±—É–¥—Ç–æ –∫–ª–∏–∫–Ω—É–ª–∏)
            marker.openPopup();

            // –ì. –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã (–∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏), —á—Ç–æ–±—ã –∑—Ä–∏—Ç–µ–ª—å –ø—Ä–æ—á–∏—Ç–∞–ª
            await wait(3000);
            
            // –î. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –ø–µ—Ä–µ–¥ –ø–æ–ª–µ—Ç–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            marker.closePopup();
        }

        // 3. –§–∏–Ω–∞–ª: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–∏–π –≤–∏–¥ –∫–∞—Ä—Ç—ã
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
        alert("–¢—É—Ä –∑–∞–≤–µ—Ä—à–µ–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π!");
    }
</script>
{% endblock %}
