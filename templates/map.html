{% extends "base.html" %}

{% block content %}
<!-- –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –º—ã –£–î–ê–õ–ò–õ–ò -->

<div class="row h-100 mt-3"> <!-- –î–æ–±–∞–≤–∏–ª –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É (mt-3) -->
    
    <!-- –°–∞–π–¥–±–∞—Ä (–ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
    <div class="col-lg-4 order-lg-2 mb-4">
        
        <!-- –ó–ê–ì–û–õ–û–í–û–ö –¢–ï–ü–ï–†–¨ –ó–î–ï–°–¨ -->
        <h3 class="mb-3 text-success">üó∫Ô∏è –¢—É—Ä: ¬´–ü–µ—Ä–º—å –í–µ–ª–∏–∫–∞—è¬ª</h3>
        
        <!-- –í–∞–∂–Ω–æ: id="sidebar-container" –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–æ–º -->
        <div id="sidebar-container" class="list-group shadow-sm overflow-auto" style="max-height: 600px; position: relative;">
            <div class="list-group-item list-group-item-action active bg-success border-success">
                –ú–∞—Ä—à—Ä—É—Ç
            </div>
            {% for stop in stops %}
            <a href="/stop/{{ stop.id }}" id="link-{{ loop.index0 }}" class="list-group-item list-group-item-action transition-bg">
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>{{ stop.id }}.</strong> {{ stop.title }}</span>
                    <span class="badge bg-light text-dark border opacity-50">Info</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ (–õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
    <div class="col-lg-8 order-lg-1">
        <div id="map-container" style="position: relative;">
            <div id="map" class="shadow-lg border border-3 border-white" style="height: 600px; width: 100%; border-radius: 12px;"></div>
        </div>
    </div>
</div>

<style>
    .transition-bg { transition: all 0.5s ease; }
    .active-item { 
        background-color: #f1f8e9 !important; 
        border-left: 4px solid #43a047 !important;
        font-weight: bold;
        color: #1b5e20;
    }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. –ù–ê–°–¢–†–û–ô–ö–ò
    var stops = {{ stops | tojson }};
    var isUserInteracting = false;
    var lastInteractionTime = 0;
    
    // === –ù–û–í–û–ï: –ß–∏—Ç–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
    // –ò—â–µ–º ?start_at=... –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    const urlParams = new URLSearchParams(window.location.search);
    const startAtId = urlParams.get('start_at');
    
    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –µ—Å—Ç—å, –∏—â–µ–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ ID. –ï—Å–ª–∏ –Ω–µ—Ç - –Ω–∞—á–∏–Ω–∞–µ–º —Å 0.
    var currentStopIndex = 0;
    if (startAtId) {
        // findIndex –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ
        let foundIndex = stops.findIndex(s => s.id == startAtId);
        if (foundIndex !== -1) {
            currentStopIndex = foundIndex;
        }
    }
    // ===================================
    
    // 2. –ö–ê–†–¢–ê
    var map = L.map('map', {
        attributionControl: false,
        zoomControl: false,
        fadeAnimation: true,
        zoomAnimation: true,
        markerZoomAnimation: true
    });
    
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19,
        keepBuffer: 20
    }).addTo(map);

    // –ú–∞—Ä–∫–µ—Ä—ã
    var markersList = []; 
    var markersGroup = L.featureGroup();

    stops.forEach(function(stop) {
        var marker = L.marker(stop.coords);
        var popupContent = `
            <div style="text-align: center;">
                <h6 style="margin: 0; color: #004d40;">${stop.title}</h6>
                <a href="/stop/${stop.id}" class="btn btn-sm btn-success text-white mt-2">–û—Ç–∫—Ä—ã—Ç—å</a>
            </div>
        `;
        marker.bindPopup(popupContent);
        marker.addTo(markersGroup);
        markersList.push(marker);
    });
    markersGroup.addTo(map);

    var routeCoordinates = stops.map(s => s.coords);
    if (routeCoordinates.length > 0) routeCoordinates.push(routeCoordinates[0]);
    L.polyline(routeCoordinates, {
        color: '#d32f2f', weight: 4, opacity: 0.7, dashArray: '10, 10'
    }).addTo(map);

    var group = new L.featureGroup([markersGroup]);
    
    // –ï—Å–ª–∏ –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º—Å—è —Å—Ä–∞–∑—É –Ω–∞ –Ω—É–∂–Ω–æ–π —Ç–æ—á–∫–µ, –∞ –Ω–µ –Ω–∞ –≤—Å–µ–π –∫–∞—Ä—Ç–µ
    if (startAtId) {
         // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, flyTo —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É
    } else {
         map.fitBounds(group.getBounds(), { padding: [50, 50] });
    }

    // 3. –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –î–ï–ô–°–¢–í–ò–ô (–ü–ê–£–ó–ê)
    const mapDiv = document.getElementById('map');
    const userEvents = ['mousedown', 'touchstart', 'wheel', 'keydown'];

    userEvents.forEach(evt => {
        mapDiv.addEventListener(evt, () => {
            isUserInteracting = true;
            lastInteractionTime = Date.now();
            map.stop(); 
        }, { passive: true });
    });

    // 4. –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ
    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    function scrollToActiveItem(index) {
        const container = document.getElementById('sidebar-container');
        const activeLink = document.getElementById('link-' + index);
        
        if (container && activeLink) {
            const topPos = activeLink.offsetTop - (container.clientHeight / 2) + (activeLink.clientHeight / 2);
            container.scrollTo({ top: topPos, behavior: 'smooth' });
        }
    }

    async function runTour() {
        // –ï—Å–ª–∏ –º—ã –ø—Ä–∏—à–ª–∏ —Å –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (startAtId –µ—Å—Ç—å), —Å—Ç–∞—Ä—Ç—É–µ–º –±—ã—Å—Ç—Ä–µ–µ
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –∫–∞—Ä—Ç—É —Å –Ω—É–ª—è - –∂–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã
        let initialDelay = startAtId ? 1000 : 2000;
        await wait(initialDelay);

        while (true) {
            // –ü–†–û–í–ï–†–ö–ê –ü–ê–£–ó–´
            if (Date.now() - lastInteractionTime < 5000) {
                if (!isUserInteracting) isUserInteracting = true;
                await wait(500);
                continue;
            }
            if (isUserInteracting) isUserInteracting = false;

            // –ü–û–î–ì–û–¢–û–í–ö–ê
            let currentStop = stops[currentStopIndex];
            let marker = markersList[currentStopIndex];
            let targetZoom = currentStop.zoom || 12;

            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active-item'));
            let activeLink = document.getElementById('link-' + currentStopIndex);
            if (activeLink) {
                activeLink.classList.add('active-item');
                scrollToActiveItem(currentStopIndex);
            }

            // –ü–û–õ–ï–¢
            map.flyTo(currentStop.coords, targetZoom, { 
                duration: 4, 
                easeLinearity: 0.5, 
                noMoveStart: true 
            });

            // –ñ–¥–µ–º
            let flightInterrupted = false;
            for (let t = 0; t < 4200; t += 100) {
                if (Date.now() - lastInteractionTime < 5000) { flightInterrupted = true; break; }
                await wait(100);
            }
            if (flightInterrupted) continue;

            // –°–¢–û–Ø–ù–ö–ê
            marker.openPopup();
            
            let pauseInterrupted = false;
            for (let t = 0; t < 5000; t += 100) {
                if (Date.now() - lastInteractionTime < 5000) { pauseInterrupted = true; break; }
                await wait(100);
            }
            
            if (!pauseInterrupted) {
                marker.closePopup();
                currentStopIndex++;
                if (currentStopIndex >= stops.length) currentStopIndex = 0;
            }
        }
    }

    runTour();
</script>
{% endblock %}
