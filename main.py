# main.py
from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

app = FastAPI()

# Подключаем папку со статикой (картинки, стили, аудио)
app.mount("/static", StaticFiles(directory="static"), name="static")

# Подключаем папку с HTML-шаблонами
templates = Jinja2Templates(directory="templates")

# ============================================================
# БЛОК ДАННЫХ (Контент, который оценивает комиссия)
# ============================================================

# 1. ОБЩАЯ ИНФОРМАЦИЯ О РЕГИОНЕ
REGION_INFO = {
    "title": "Пермский край",
    "subtitle": "Место силы, где Европа встречается с Азией",
    
    # Блок 1: География
    "geography_title": "География и Природа",
    "geography_text": """
        Пермский край занимает площадь 160 тыс. км² (больше Греции или Исландии). 
        99,8% территории находится в Европе, и лишь 0,2% — в Азии. 
        Главная артерия региона — река Кама, одна из крупнейших рек Европы. 
        Край называют «лесным регионом»: тайга покрывает более 71% территории. 
        Здесь находится знаменитая Кунгурская ледяная пещера и более 29 тысяч других карстовых воронок и пещер.
    """,

    # Блок 2: Экономика
    "economy_title": "Промышленная мощь",
    "economy_text": """
        Один из индустриальных центров России. Здесь добывают 97% российского калия 
        (Верхнекамское месторождение — второе в мире по запасам). 
        В Перми производят авиационные двигатели ПС-90А и ПД-14 (для самолетов МС-21), 
        перерабатывают нефть и газ, создают ракетные двигатели («Протон-ПМ»). 
        Развит IT-сектор: именно в Перми родились такие мировые компании, как Xsolla и Promobot.
    """,

    # Блок 3: История и Период
    "history_title": "Пермский период и История",
    "history_text": """
        Пермь — единственный город мира, давший название целому геологическому периоду 
        (Пермский период, длился 47 млн лет). Его открыл шотландец Родерик Мурчисон в 1841 году.
        Исторически это земли «Перми Великой». В XV–XVI веках здесь властвовали купцы Строгановы, 
        которые организовали поход Ермака в Сибирь, превратив регион в плацдарм для освоения Востока.
    """,

    # Блок 4: Культура
    "culture_title": "Культурный феномен",
    "culture_text": """
        Пермь часто называют третьей культурной столицей России. 
        Пермский театр оперы и балета — один из старейших в стране, колыбель знаменитых сезонов Дягилева. 
        Уникальным явлением является «Пермская деревянная скульптура» («Пермские боги») — 
        синтез православия и язычества, когда Христа изображали с лицами местных коми-пермяков.
    """,

    # Блок 5: Население
    "people_title": "Население и Традиции",
    "people_text": """
        В крае проживает около 2.5 млн человек. Это многонациональный регион: здесь мирно соседствуют 
        русские, татары, коми-пермяки, башкиры и удмурты. 
        Коми-пермяцкий округ сохранил уникальный язык и кухню (знаменитые пирожки-посикунчики и пельмени, 
        ведь само слово «пельмень» происходит от пермского «пельнянь» — хлебное ухо).
    """
}

STOPS = [
    {
        "id": 1,
        "title": "Пермская художественная галерея",
        "coords": [58.0171, 56.2346], # Реальные координаты
        "zoom": 16,  # <-- БЛИЗКО (Центр города)
        "short_desc": "Дом пермских деревянных богов.",
        "full_desc": """
            Галерея расположена в здании Спасо-Преображенского кафедрального собора. 
            Главное сокровище коллекции — пермская деревянная скульптура («пермские боги»). 
            Это уникальный синтез христианства и язычества, возникший в XVII–XIX веках. 
            Местные народы, приняв православие, продолжали вырезать идолов, но уже в виде Христа и святых. 
            Объект имеет мировое культурное значение.
        """,
        "images": ["gallery.jpg", "galery1.jpg", "galery2.jpeg", "galery3.jpg", "galery4.jpg", "galery5.webp", "galery6.webp"],
        "audio": "stop1.wav",  # Файл для аудиогида
        "type": "culture"
    },
    {
        "id": 2,
        "title": "Скульптура «Пермяк — соленые уши»",
        "coords": [58.0094, 56.2407],
        "zoom": 17,  # <-- ОЧЕНЬ БЛИЗКО (Маленький памятник)
        "short_desc": "Самый странный и веселый памятник России.",
        "full_desc": """
            Памятник посвящен поговорке, связанной с традиционным промыслом региона. 
            Рабочие-соленосы таскали мешки с солью на плечах, отчего их уши пропитывались 
            солью, краснели и распухали. Скульптура состоит из рамки с ушами (где можно сфотографироваться) 
            и фигуры фотографа. Символ самоиронии пермяков.
        """,
        "images": ["ushi.jpg", "ushi1.webp"],
        "audio": "stop8.wav",
        "type": "culture"
    },
    {
        "id": 3,
        "title": "Завод Шпагина (Культурное пространство)",
        "coords": [58.0125, 56.2486],
        "zoom": 16, # <-- БЛИЗКО
        "short_desc": "Пример ревитализации промышленного наследия.",
        "full_desc": """
            Бывшие цеха ремонтных мастерских железной дороги, превращенные в современный 
            культурный кластер. Это отличный пример того, как старое промышленное пространство 
            получает новую жизнь (креативная экономика), сохраняя исторический облик стен, 
            где трудились поколения пермских рабочих.
        """,
        "images": ["shpagin.jpg", "shpagin1.webp", "shpagin2.jpg", "shpagin3.webp"],
        "audio": "stop10.wav",
        "type": "modern"
    },
    {
        "id": 4,
        "title": "Архитектурно-этнографический музей «Хохловка»",
        "coords": [58.2662, 56.2612],
        "zoom": 14, # <-- СРЕДНЕ (Территория большая)
        "short_desc": "Деревянное зодчество под открытым небом.",
        "full_desc": """
            Музей расположен на живописном мысу Камы. Сюда со всего края свезены 
            уникальные образцы деревянной архитектуры XVII–XX веков: церкви, 
            солеварни, ветряная мельница, усадьбы крестьян. Здесь можно увидеть, 
            как добывали соль — «белое золото», сделавшее Строгановых богатейшими людьми России.
        """,
        "images": ["hohlovka.jpg", "hohlovka1.webp", "hohlovka2.webp", "hohlovka3.webp", "hohlovka4.jpg", "hohlovka5.jpg"],
        "audio": "stop2.wav",
        "type": "history"
    },
    {
        "id": 5,
        "title": "Усолье Строгановское",
        "coords": [59.4182, 56.6853],
        "zoom": 14,
        "short_desc": "Архитектурный ансамбль «Петербург на Каме».",
        "full_desc": """
            Исторический центр солеварения на Урале. Здесь сохранились палаты Строгановых 
            и Спасо-Преображенский собор, построенные в стиле «строгановского барокко». 
            Усолье было столицей империи Строгановых — промышленников, которые 
            снарядили поход Ермака и фактически присоединили Сибирь к России.
        """,
        "images": ["usolye.jpg", "usolye1.webp", "usolye2.webp", "usolye3.jpg"],
        "audio": "stop7.wav",
        "type": "history"
    },
    {
        "id": 6,
        "title": "Каменный город (Чертово городище)",
        "coords": [58.7226, 57.6331],
        "zoom": 10, # <-- ДАЛЕКО (Чтобы видеть гору и тайгу вокруг)
        "short_desc": "Лабиринт скал, созданный природой 300 млн лет назад.",
        "full_desc": """
            Природный памятник, представляющий собой причудливые скальные останцы, 
            изрезанные глубокими трещинами, напоминающими улицы древнего города. 
            Геологически это дно древнего Пермского моря. Место овеяно легендами 
            и обладает особой энергетикой, привлекающей туристов и эзотериков.
        """,
        "images": ["stone_city.jpg", "stone_city1.webp", "stone_city2.webp", "stone_city3.webp"],
        "audio": "stop6.wav",
        "type": "nature"
    },
    {
        "id": 7,
        "title": "Гора Полюд (Полюдов камень)",
        "coords": [60.4844, 57.0048],
        "zoom": 13,
        "short_desc": "Страж Вишеры, легендарный богатырь.",
        "full_desc": """
            Гора на севере края, высотой 527 метров. Согласно легенде, Полюд — это 
            окаменевший богатырь, который защищал чердынскую землю от врагов. 
            С вершины открывается невероятный вид на «море» тайги и соседний камень Ветлан. 
            Популярнейшее место для зимнего и летнего туризма.
        """,
        "images": ["polyud.jpg", "polyud1.webp", "polyud2.jpg", "polyud3.webp"],
        "audio": "stop9.wav",
        "type": "nature"
    },
    {
        "id": 8,
        "title": "Кунгурская ледяная пещера",
        "coords": [57.4418, 57.0062],
        "zoom": 14,
        "short_desc": "Одно из чудес России, царство льда и камня.",
        "full_desc": """
            Одна из крупнейших карстовых пещер в Европейской части России. 
            Протяженность ходов — более 5,7 км. Уникальность пещеры в её микроклимате: 
            даже летом здесь сохраняются ледяные сталактиты и сталагмиты. 
            Пещера окутана легендами о Ермаке, который, по преданию, зимовал здесь перед походом в Сибирь.
        """,
        "images": ["kungur.jpg", "kungur1.jpg", "kungur2.webp", "kungur3.webp"],
        "audio": "stop4.wav",
        "type": "nature"
    },
    {
        "id": 9,
        "title": "Белогорский монастырь",
        "coords": [57.3919, 56.2303],
        "zoom": 13,
        "short_desc": "Уральский Афон, жемчужина православного Урала.",
        "full_desc": """
            Крестовоздвиженский собор монастыря — самый величественный храм Пермской епархии. 
            Он стоит на вершине Белой горы, откуда открывается вид на десятки километров уральской тайги. 
            Монастырь имеет трагическую судьбу: в годы Гражданской войны монахи были зверски убиты, 
            а храм осквернен. Возрождение обители стало символом духовного возрождения региона.
        """,
        "images": ["belogorye.jpg", "belogorye1.jpg", "belogorye2.jpg", "belogorye3.jpg", "belogorye4.jpg"],
        "audio": "stop5.wav",
        "type": "religion"
    },
    {
        "id": 10,
        "title": "Мемориальный музей «Пермь-36»",
        "coords": [58.2636, 57.8286],
        "zoom": 12, # <-- СРЕДНЕ (Видно монастырь на горе)
        "short_desc": "Единственный уцелевший музей истории политических репрессий.",
        "full_desc": """
            Бывшая исправительно-трудовая колония строгого режима для осужденных за «антисоветскую агитацию». 
            Здесь содержались диссиденты, писатели, ученые. Музей выполняет важнейшую 
            мемориальную функцию, напоминая о трагических страницах истории страны 
            и цене свободы слова. Объект включен в список памятников истории мирового значения.
        """,
        "images": ["perm36.jpg", "perm361.webp", "perm362.webp", "perm363.webp", "perm364.webp"],
        "audio": "stop3.wav",
        "type": "memory"
    }
]

# ============================================================
# ЛОГИКА ПРИЛОЖЕНИЯ (Роутинг)
# ============================================================

@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    """
    Главная страница.
    Передаем данные о регионе в шаблон index.html
    """
    return templates.TemplateResponse("index.html", {
        "request": request,
        "info": REGION_INFO
    })

@app.get("/map", response_class=HTMLResponse)
async def read_map(request: Request):
    """
    Страница с картой.
    Передаем список остановок (STOPS) в шаблон map.html
    для отображения маркеров через JavaScript.
    """
    return templates.TemplateResponse("map.html", {
        "request": request, 
        "stops": STOPS
    })

@app.get("/stop/{stop_id}", response_class=HTMLResponse)
async def read_stop(request: Request, stop_id: int):
    # 1. Находим индекс текущей остановки в списке
    # (enumerate помогает получить и индекс, и сам объект)
    current_index = next((i for i, s in enumerate(STOPS) if s["id"] == stop_id), None)
    
    if current_index is None:
        raise HTTPException(status_code=404, detail="Остановка не найдена")
    
    stop = STOPS[current_index]

    # 2. Вычисляем ID соседей (с зацикливанием: после последнего идет первый)
    prev_index = (current_index - 1) % len(STOPS)
    next_index = (current_index + 1) % len(STOPS)
    
    prev_id = STOPS[prev_index]["id"]
    next_id = STOPS[next_index]["id"]

    return templates.TemplateResponse("stop.html", {
        "request": request, 
        "stop": stop,
        "prev_id": prev_id,
        "next_id": next_id
    })
