# main.py
from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

app = FastAPI()

# Подключаем папку со статикой (картинки, стили, аудио)
app.mount("/static", StaticFiles(directory="static"), name="static")

# Подключаем папку с HTML-шаблонами
templates = Jinja2Templates(directory="templates")

# ============================================================
# БЛОК ДАННЫХ (Контент, который оценивает комиссия)
# ============================================================

# 1. ОБЩАЯ ИНФОРМАЦИЯ О РЕГИОНЕ
# Закрывает критерий: "объективные данные о географии, ресурсах, экономике..."
REGION_INFO = {
    "title": "Пермский край: Сердце Пармы",
    "subtitle": "Край легенд, соляных промыслов и заводской цивилизации",
    "geography": """
        Пермский край расположен на восточной окраине Восточно-Европейской равнины 
        и западном склоне Среднего и Северного Урала. Это уникальная точка на карте: 
        здесь Европа встречается с Азией. Главная водная артерия — могучая река Кама, 
        объединяющая регион в единую транспортную сеть. Площадь края сравнима с 
        площадью целого государства, например, Греции.
    """,
    "economy": """
        Край — один из экономических локомотивов России. Основу экономики составляют 
        нефтехимия, машиностроение (в т.ч. авиадвигатели) и металлургия. 
        Исторически регион развивался благодаря колоссальным запасам калийных и магниевых солей 
        (Верхнекамское месторождение — одно из крупнейших в мире).
    """,
    "culture": """
        Культура Перми — это сплав языческих традиций финно-угорских народов 
        (знаменитый «Пермский звериный стиль») и православного зодчества. 
        Пермь известна своими «деревянными богами» — уникальной храмовой скульптурой, 
        не имеющей аналогов. В XX веке Пермь стала третьей балетной столицей России 
        после Москвы и Петербурга.
    """,
    "religion": """
        Регион многоконфессионален, но доминирует православие. Белогорский монастырь 
        часто называют «Уральским Афоном» за его величие и духовную значимость. 
        Также в крае сильны традиции старообрядчества, сохранившиеся в отдаленных таежных скитах.
    """
}

# 2. ТУРИСТИЧЕСКИЙ МАРШРУТ (минимум 10 точек)
# Тема маршрута: "Пермь Великая: Сквозь время и горы"
STOPS = [
    {
        "id": 1,
        "title": "Пермская художественная галерея",
        "coords": [58.0171, 56.2346], # Реальные координаты
        "short_desc": "Дом пермских деревянных богов.",
        "full_desc": """
            Галерея расположена в здании Спасо-Преображенского кафедрального собора. 
            Главное сокровище коллекции — пермская деревянная скульптура («пермские боги»). 
            Это уникальный синтез христианства и язычества, возникший в XVII–XIX веках. 
            Местные народы, приняв православие, продолжали вырезать идолов, но уже в виде Христа и святых. 
            Объект имеет мировое культурное значение.
        """,
        "img": "gallery.jpg",  # Файл нужно будет положить в static/img/
        "audio": "stop1.wav",  # Файл для аудиогида
        "type": "culture"
    },
    {
        "id": 2,
        "title": "Архитектурно-этнографический музей «Хохловка»",
        "coords": [58.2662, 56.2612],
        "short_desc": "Деревянное зодчество под открытым небом.",
        "full_desc": """
            Музей расположен на живописном мысу Камы. Сюда со всего края свезены 
            уникальные образцы деревянной архитектуры XVII–XX веков: церкви, 
            солеварни, ветряная мельница, усадьбы крестьян. Здесь можно увидеть, 
            как добывали соль — «белое золото», сделавшее Строгановых богатейшими людьми России.
        """,
        "img": "hohlovka.jpg",
        "audio": "stop2.wav",
        "type": "history"
    },
    {
        "id": 3,
        "title": "Мемориальный музей «Пермь-36»",
        "coords": [58.2636, 57.8286],
        "short_desc": "Единственный уцелевший музей истории политических репрессий.",
        "full_desc": """
            Бывшая исправительно-трудовая колония строгого режима для осужденных за «антисоветскую агитацию». 
            Здесь содержались диссиденты, писатели, ученые. Музей выполняет важнейшую 
            мемориальную функцию, напоминая о трагических страницах истории страны 
            и цене свободы слова. Объект включен в список памятников истории мирового значения.
        """,
        "img": "perm36.jpg",
        "audio": "stop3.wav",
        "type": "memory"
    },
    {
        "id": 4,
        "title": "Кунгурская ледяная пещера",
        "coords": [57.4418, 57.0062],
        "short_desc": "Одно из чудес России, царство льда и камня.",
        "full_desc": """
            Одна из крупнейших карстовых пещер в Европейской части России. 
            Протяженность ходов — более 5,7 км. Уникальность пещеры в её микроклимате: 
            даже летом здесь сохраняются ледяные сталактиты и сталагмиты. 
            Пещера окутана легендами о Ермаке, который, по преданию, зимовал здесь перед походом в Сибирь.
        """,
        "img": "kungur.jpg",
        "audio": "stop4.wav",
        "type": "nature"
    },
    {
        "id": 5,
        "title": "Белогорский монастырь",
        "coords": [57.3919, 56.2303],
        "short_desc": "Уральский Афон, жемчужина православного Урала.",
        "full_desc": """
            Крестовоздвиженский собор монастыря — самый величественный храм Пермской епархии. 
            Он стоит на вершине Белой горы, откуда открывается вид на десятки километров уральской тайги. 
            Монастырь имеет трагическую судьбу: в годы Гражданской войны монахи были зверски убиты, 
            а храм осквернен. Возрождение обители стало символом духовного возрождения региона.
        """,
        "img": "belogorye.jpg",
        "audio": "stop5.wav",
        "type": "religion"
    },
    {
        "id": 6,
        "title": "Каменный город (Чертово городище)",
        "coords": [58.7226, 57.6331],
        "short_desc": "Лабиринт скал, созданный природой 300 млн лет назад.",
        "full_desc": """
            Природный памятник, представляющий собой причудливые скальные останцы, 
            изрезанные глубокими трещинами, напоминающими улицы древнего города. 
            Геологически это дно древнего Пермского моря. Место овеяно легендами 
            и обладает особой энергетикой, привлекающей туристов и эзотериков.
        """,
        "img": "stone_city.jpg",
        "audio": "stop6.wav",
        "type": "nature"
    },
    {
        "id": 7,
        "title": "Усолье Строгановское",
        "coords": [59.4182, 56.6853],
        "short_desc": "Архитектурный ансамбль «Петербург на Каме».",
        "full_desc": """
            Исторический центр солеварения на Урале. Здесь сохранились палаты Строгановых 
            и Спасо-Преображенский собор, построенные в стиле «строгановского барокко». 
            Усолье было столицей империи Строгановых — промышленников, которые 
            снарядили поход Ермака и фактически присоединили Сибирь к России.
        """,
        "img": "usolye.jpg",
        "audio": "stop7.wav",
        "type": "history"
    },
    {
        "id": 8,
        "title": "Скульптура «Пермяк — соленые уши»",
        "coords": [58.0094, 56.2407],
        "short_desc": "Самый странный и веселый памятник России.",
        "full_desc": """
            Памятник посвящен поговорке, связанной с традиционным промыслом региона. 
            Рабочие-соленосы таскали мешки с солью на плечах, отчего их уши пропитывались 
            солью, краснели и распухали. Скульптура состоит из рамки с ушами (где можно сфотографироваться) 
            и фигуры фотографа. Символ самоиронии пермяков.
        """,
        "img": "ushi.jpg",
        "audio": "stop8.wav",
        "type": "culture"
    },
    {
        "id": 9,
        "title": "Гора Полюд (Полюдов камень)",
        "coords": [60.4844, 57.0048],
        "short_desc": "Страж Вишеры, легендарный богатырь.",
        "full_desc": """
            Гора на севере края, высотой 527 метров. Согласно легенде, Полюд — это 
            окаменевший богатырь, который защищал чердынскую землю от врагов. 
            С вершины открывается невероятный вид на «море» тайги и соседний камень Ветлан. 
            Популярнейшее место для зимнего и летнего туризма.
        """,
        "img": "polyud.jpg",
        "audio": "stop9.wav",
        "type": "nature"
    },
    {
        "id": 10,
        "title": "Завод Шпагина (Культурное пространство)",
        "coords": [58.0125, 56.2486],
        "short_desc": "Пример ревитализации промышленного наследия.",
        "full_desc": """
            Бывшие цеха ремонтных мастерских железной дороги, превращенные в современный 
            культурный кластер. Это отличный пример того, как старое промышленное пространство 
            получает новую жизнь (креативная экономика), сохраняя исторический облик стен, 
            где трудились поколения пермских рабочих.
        """,
        "img": "shpagin.jpg",
        "audio": "stop10.wav",
        "type": "modern"
    }
]

# ============================================================
# ЛОГИКА ПРИЛОЖЕНИЯ (Роутинг)
# ============================================================

@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    """
    Главная страница.
    Передаем данные о регионе в шаблон index.html
    """
    return templates.TemplateResponse("index.html", {
        "request": request,
        "info": REGION_INFO
    })

@app.get("/map", response_class=HTMLResponse)
async def read_map(request: Request):
    """
    Страница с картой.
    Передаем список остановок (STOPS) в шаблон map.html
    для отображения маркеров через JavaScript.
    """
    return templates.TemplateResponse("map.html", {
        "request": request, 
        "stops": STOPS
    })

@app.get("/stop/{stop_id}", response_class=HTMLResponse)
async def read_stop(request: Request, stop_id: int):
    """
    Динамическая страница конкретной точки.
    Ищет точку по ID. Если не находит - выдает 404.
    """
    stop = next((s for s in STOPS if s["id"] == stop_id), None)
    if not stop:
        raise HTTPException(status_code=404, detail="Остановка не найдена")
    
    return templates.TemplateResponse("stop.html", {
        "request": request, 
        "stop": stop
    })
